
<h1><a href="pusher.rb">pusher.rb</a></h1>
<style>
textarea{width:400px;height:200px;}
</style>
<textarea>
require 'json'
require 'digest/sha2'
require 'net/http'
module Pusher
  ENDPOINT = 'fierce-beach-8052.herokuapp.com'
  class << self
    attr_writer :SECRET_KEY
    def SECRET_KEY
      @SECRET_KEY || ENV['PUSHER_SECRET_KEY'] || (@RAND_KEY||=rand)
    end

    def send data, models=nil
      models = [models] unless models.is_a? Array
      query = {
        keys: models.map{|m|group_id m}.to_json,
        data: data.to_json
      }
      Net::HTTP.new(*ENDPOINT.split(':')).post('/', URI.encode_www_form(query))
    end

    def group_id model
      if model.respond_to? :id
        key = "#{model.class.name}_#{model.id}"
      else
        key = model.to_s
      end
      "#{self.SECRET_KEY}_#{key}"
    end

    def listen *models
      models.push(nil).map{|model|Digest::SHA2.hexdigest group_id(model)}.to_json
    end
  end
end
</textarea>


<h1>embed code</h1>
<textarea>
<script>
var PUSHER_ENDPOINT='<%= Pusher::ENDPOINT %>'
var PUSHER_GROUPS=<%= Pusher.listen current_user, current_user.some_group %>;
window.addEventListener('load',function(){
  var ss=['socket.io/socket.io.js','pusher.js'];
  for(i in ss){
    var d=document;s=d.createElement('script');
    s.src='http://'+PUSHER_ENDPOINT+'/'+ss[i];
    d.body.appendChild(s);
  }
});
</script>
</textarea>

<h1>how to use</h1>
<textarea>
#configure
Pusher.SECRET_KEY='your_secret_key'

#send
Pusher.send data
Pusher.send data, 'key'
Pusher.send data, current_user
Pusher.send data, [user1, user2, Post.first, user3.group]
</textarea>
